<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <th:block th:include="fragments/header.html :: header(title = 'Whiteboard')"/>
    <meta class="firebaseKey" th:content="${firebaseKey}"/>
    <title>Whiteboard</title>
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/5.5.4/firebase.js"></script>
    <!-- ACE and its JavaScript mode and theme files -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.5/ace.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.5/mode-javascript.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.2.5/theme-textmate.js"></script>
    <!-- Firepad -->
    <link rel="stylesheet" href="https://firepad.io/releases/v1.5.9/firepad.css" />
    <script src="https://firepad.io/releases/v1.5.9/firepad.min.js"></script>
    <style>
        html { height: 100%; }
        body { margin: 0; height: 100%; position: relative; }
        /* Height / width / positioning can be customized for your use case.
           For demo purposes, we make firepad fill the entire browser. */
        #firepad-container {
            width: 100%;
            height: 90%;
        }
    </style>
</head>
<body onload="init()">
<div id="firepad-container"></div>
<div th:each="post : ${questionsList}">
    <input th:id="'question-' + ${post.id}" type="hidden" th:value="${post.body}">
    <button th:text="'Question' + ${post.id}" class="question-button" th:id="'question-button-' + ${post.id}"></button>
</div>
<script type="text/javascript" th:src="@{~/js/keys.js}"></script>

<script>
    let firepad;
    function init() {
        //// Initialize Firebase.
        const config = {
            apiKey: document.querySelector('meta.firebaseKey').content,
            authDomain: "codeon-49481.firebaseapp.com",
            databaseURL: "https://codeon-49481.firebaseio.com"
        };
        firebase.initializeApp(config);

        //// Get Firebase Database reference.
        let firepadRef = getExampleRef();

        //// Create ACE
        let editor = ace.edit("firepad-container");
        editor.setTheme("ace/theme/textmate");
        let session = editor.getSession();
        session.setUseWrapMode(true);
        session.setUseWorker(false);
        session.setMode("ace/mode/javascript");

        //// Create Firepad.
        firepad = Firepad.fromACE(firepadRef, editor, {
            defaultText: 'Welcome to CodeOn WhiteBoard. Please wait for your facilitator.'
        });
    }

    // Helper to get hash from end of URL or generate a random one.
    function getExampleRef() {
        let ref = firebase.database().ref();
        let hash = window.location.hash.replace(/#/g, '');
        if (hash) {
            ref = ref.child(hash);
        } else {
            ref = ref.push(); // generate unique location.
            window.location = window.location + '#' + ref.key; // add it as a hash to the URL.
        }
        if (typeof console !== 'undefined') {
            console.log('Firebase data: ', ref.toString());
        }
        return ref;
    }
    function loadQuestion() {
        firepad.setText("");
        let id = this.getAttribute("id").split("-")[2];
        console.log(id);
        fetch(`/api/questions/${id}`, {
            method: 'GET'
        })
            .then(response => {
                return response.json();
            })
            .then(res => {
                console.log(res);
                firepad.setText(res.body);
            })
    }
    document.querySelectorAll(".question-button").forEach(button => {
        button.addEventListener("click", loadQuestion);
    })

</script>
</body>
</html>

<!DOCTYPE html>
